name: テスト環境デプロイ

on:
  push:
    branches:
      - test

jobs:
  deploy:
    name: テスト環境へデプロイ
    runs-on: ubuntu-latest

    steps:
      - name: コードをチェックアウト
        uses: actions/checkout@v4

      - name: AWS認証情報を設定
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Session Manager Pluginをインストール
        run: |
          curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
          sudo dpkg -i session-manager-plugin.deb

      - name: EC2に接続してデプロイスクリプトを実行
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.TEST_EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --timeout-seconds 3600 \
            --parameters 'commands=["set -e","sudo -u ubuntu bash -c \"cd ${{ secrets.TEST_DEPLOY_PATH }} && git pull origin test && echo ========================================= && echo テスト環境デプロイを開始します && echo ========================================= && ./scripts/deploy.sh test && echo ========================================= && echo デプロイが正常に完了しました && echo ==========================================\""]' \
            --output text \
            --query "Command.CommandId")

          echo "コマンドID: $COMMAND_ID"

          # コマンドの完了を待つ（最大60分、30秒ごとにチェック）
          echo "デプロイの完了を待っています..."
          MAX_ATTEMPTS=120
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ secrets.TEST_EC2_INSTANCE_ID }}" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            echo "[$ATTEMPT/$MAX_ATTEMPTS] ステータス: $STATUS"
            
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              break
            fi
            
            sleep 30
          done

          # コマンドの結果を取得
          echo "========================================="
          echo "デプロイ結果:"
          echo "========================================="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.TEST_EC2_INSTANCE_ID }}" \
            --query '[Status,StandardOutputContent,StandardErrorContent]' \
            --output text

          # ステータスを確認
          if [ "$STATUS" != "Success" ]; then
            echo "❌ デプロイが失敗しました (ステータス: $STATUS)"
            exit 1
          fi

      - name: デプロイ成功を記録
        run: |
          echo "✅ テスト環境へのデプロイが成功しました"
          echo "デプロイ日時: $(date)"
          echo "コミット: ${{ github.sha }}"

      - name: デプロイ失敗時の通知
        if: failure()
        run: |
          echo "❌ テスト環境へのデプロイが失敗しました"
          echo "デプロイ日時: $(date)"
          echo "コミット: ${{ github.sha }}"
          echo "ログを確認してください: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
