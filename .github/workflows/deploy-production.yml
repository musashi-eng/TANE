name: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: æœ¬ç•ªç’°å¢ƒã¸ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ã‚¿ã‚°ä½œæˆã®ãŸã‚å…¨å±¥æ­´ã‚’å–å¾—

      - name: AWSèªè¨¼æƒ…å ±ã‚’è¨­å®š
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Session Manager Pluginã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
          sudo dpkg -i session-manager-plugin.deb

      - name: EC2ã«æ¥ç¶šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.PROD_EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --timeout-seconds 3600 \
            --parameters 'commands=["set -e","sudo -u ubuntu bash -c \"cd ${{ secrets.PROD_DEPLOY_PATH }} && git pull origin main && echo ========================================= && echo æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™ && echo ========================================= && ./scripts/deploy.sh prod && echo ========================================= && echo ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ && echo ==========================================\""]' \
            --output text \
            --query "Command.CommandId")
          
          echo "ã‚³ãƒãƒ³ãƒ‰ID: $COMMAND_ID"
          
          # ã‚³ãƒãƒ³ãƒ‰ã®å®Œäº†ã‚’å¾…ã¤ï¼ˆæœ€å¤§60åˆ†ã€30ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ï¼‰
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤ã®å®Œäº†ã‚’å¾…ã£ã¦ã„ã¾ã™..."
          MAX_ATTEMPTS=120
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ secrets.PROD_EC2_INSTANCE_ID }}" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            echo "[$ATTEMPT/$MAX_ATTEMPTS] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS"
            
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              break
            fi
            
            sleep 30
          done
          
          # ã‚³ãƒãƒ³ãƒ‰ã®çµæœã‚’å–å¾—
          echo "========================================="
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ:"
          echo "========================================="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.PROD_EC2_INSTANCE_ID }}" \
            --query '[Status,StandardOutputContent,StandardErrorContent]' \
            --output text
          
          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
          if [ "$STATUS" != "Success" ]; then
            echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS)"
            exit 1
          fi

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã‚’è¨˜éŒ²
        run: |
          echo "âœ… æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸ"
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚: $(date)"
          echo "ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"

      - name: Gitã‚¿ã‚°ã‚’ä½œæˆ
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’ç”Ÿæˆï¼ˆæ—¥ä»˜ãƒ™ãƒ¼ã‚¹ï¼‰
          TAG_NAME="v$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)"
          
          # æ—¢å­˜ã®ã‚¿ã‚°ã‚’ç¢ºèª
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "âš ï¸ ã‚¿ã‚° $TAG_NAME ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          else
            git tag -a "$TAG_NAME" -m "Production deployment"
            git push origin "$TAG_NAME"
            echo "âœ… ã‚¿ã‚° $TAG_NAME ã‚’ä½œæˆã—ã¾ã—ãŸ"
          fi

      - name: GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            ## ğŸš€ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
            
            æœ¬ç•ªç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸã€‚
            
            ### ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±
            - **ç’°å¢ƒ**: æœ¬ç•ªç’°å¢ƒ
            - **ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚**: ${{ github.event.head_commit.timestamp }}
            - **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
            - **ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ${{ github.event.head_commit.message }}
            
            ### å¤‰æ›´å†…å®¹
            ${{ github.event.head_commit.message }}
          draft: false
          prerelease: false
        continue-on-error: true # ãƒªãƒªãƒ¼ã‚¹ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ã®é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚: $(date)"
          echo "ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
